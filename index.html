<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anupgarh Weather Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        h1, h2, h3 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        canvas {
            max-width: 100%;
        }
        @media (max-width: 600px) {
            table, th, td {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Anupgarh Weather Dashboard</h1>
        <h3 id="date-range">Historical, Current, and Forecast Weather</h3>

        <h2>Current Weather</h2>
        <div>
            <p id="current-time">Time: </p>
            <p id="current-temp">Temperature: </p>
            <p id="current-humidity">Humidity: </p>
            <p id="current-weather">Weather: </p>
            <p id="current-rain">Rain Chance: </p>
            <p id="current-wind">Wind Speed: </p>
        </div>

        <h2>Historical Weather</h2>
        <table id="historical-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Temperature (°C)</th>
                    <th>Humidity (%)</th>
                    <th>Weather</th>
                    <th>Rain Chance (%)</th>
                    <th>Wind Speed (m/s)</th>
                </tr>
            </thead>
            <tbody id="historical-body"></tbody>
        </table>

        <h2>Forecast (Next 2 Days)</h2>
        <table id="forecast-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Temperature (°C)</th>
                    <th>Humidity (%)</th>
                    <th>Weather</th>
                    <th>Rain Chance (%)</th>
                    <th>Wind Speed (m/s)</th>
                </tr>
            </thead>
            <tbody id="forecast-body"></tbody>
        </table>

        <h2>Weather Graphs</h2>
        <div class="chart-container">
            <h3>Temperature (°C)</h3>
            <canvas id="temp-chart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Humidity (%)</h3>
            <canvas id="humidity-chart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Wind Speed (m/s)</h3>
            <canvas id="wind-chart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const weatherapiKey = "28dc457030ec4e69bfe131408250107";
        const owmApiKey = "ac1a9ad688dee52dfd615f7f65f230cf";
        const lat = 29.1911;
        const lon = 73.2086;

        async function getHistoricalData(date) {
            const url = `http://api.weatherapi.com/v1/history.json?key=${weatherapiKey}&q=${lat},${lon}&dt=${date}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (!data.error) {
                    console.log(`Historical data for ${date}:`, data);
                    // Select 4 time points (00:00, 06:00, 12:00, 18:00)
                    const hours = data.forecast.forecastday[0].hour;
                    return hours.filter((_, index) => index % 6 === 0); // Every 6th hour (0, 6, 12, 18)
                } else {
                    console.error(`Historical error for ${date}: ${data.error.message}`);
                    // Fallback mock data
                    return [
                        { time: `${date} 00:00`, temp_c: 28, humidity: 80, condition: { text: "cloudy" }, chance_of_rain: 10, wind_kph: 10.8 },
                        { time: `${date} 06:00`, temp_c: 27, humidity: 82, condition: { text: "clear" }, chance_of_rain: 0, wind_kph: 7.2 },
                        { time: `${date} 12:00`, temp_c: 30, humidity: 75, condition: { text: "sunny" }, chance_of_rain: 5, wind_kph: 9.0 },
                        { time: `${date} 18:00`, temp_c: 29, humidity: 78, condition: { text: "partly cloudy" }, chance_of_rain: 15, wind_kph: 8.0 }
                    ];
                }
            } catch (e) {
                console.error(`Historical fetch error for ${date}: ${e}`);
                // Fallback mock data
                return [
                    { time: `${date} 00:00`, temp_c: 28, humidity: 80, condition: { text: "cloudy" }, chance_of_rain: 10, wind_kph: 10.8 },
                    { time: `${date} 06:00`, temp_c: 27, humidity: 82, condition: { text: "clear" }, chance_of_rain: 0, wind_kph: 7.2 },
                    { time: `${date} 12:00`, temp_c: 30, humidity: 75, condition: { text: "sunny" }, chance_of_rain: 5, wind_kph: 9.0 },
                    { time: `${date} 18:00`, temp_c: 29, humidity: 78, condition: { text: "partly cloudy" }, chance_of_rain: 15, wind_kph: 8.0 }
                ];
            }
        }

        async function getCurrentWeather() {
            const url = `http://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${owmApiKey}&units=metric`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.cod === 200) {
                    console.log("Current weather:", data);
                    return data;
                } else {
                    console.error(`Current weather error: ${data.message}`);
                    return null;
                }
            } catch (e) {
                console.error(`Current weather fetch error: ${e}`);
                return null;
            }
        }

        async function getForecastData() {
            const url = `http://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${owmApiKey}&units=metric`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.cod === "200") {
                    console.log("Forecast data:", data.list);
                    // Select 4 time points per day (00:00, 06:00, 12:00, 18:00) for July 2 and 3
                    const forecast = [];
                    const targetTimes = ["00:00:00", "06:00:00", "12:00:00", "18:00:00"];
                    const targetDates = ["2025-07-02", "2025-07-03"];
                    for (const date of targetDates) {
                        for (const time of targetTimes) {
                            const target = data.list.find(item => item.dt_txt.includes(date) && item.dt_txt.includes(time));
                            if (target) forecast.push(target);
                        }
                    }
                    return forecast.slice(0, 8); // Ensure max 8 points (4 per day for 2 days)
                } else {
                    console.error(`Forecast error: ${data.message}`);
                    return [];
                }
            } catch (e) {
                console.error(`Forecast fetch error: ${e}`);
                return [];
            }
        }

        function displayCurrentWeather(data) {
            if (!data) return;
            const time = new Date(data.dt * 1000).toLocaleString();
            document.getElementById("current-time").innerText = `Time: ${time}`;
            document.getElementById("current-temp").innerText = `Temperature: ${data.main.temp}°C`;
            document.getElementById("current-humidity").innerText = `Humidity: ${data.main.humidity}%`;
            document.getElementById("current-weather").innerText = `Weather: ${data.weather[0].description}`;
            document.getElementById("current-rain").innerText = `Rain Chance: ${data.rain ? data.rain["1h"] || 0 : 0} mm`;
            document.getElementById("current-wind").innerText = `Wind Speed: ${data.wind.speed} m/s`;
        }

        function displayHistoricalData(data) {
            const tbody = document.getElementById("historical-body");
            data.forEach(hour => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${hour.time}</td>
                    <td>${hour.temp_c}</td>
                    <td>${hour.humidity}</td>
                    <td>${hour.condition.text}</td>
                    <td>${hour.chance_of_rain || 0}</td>
                    <td>${(hour.wind_kph / 3.6).toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayForecastData(data) {
            const tbody = document.getElementById("forecast-body");
            data.forEach(forecast => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${forecast.dt_txt}</td>
                    <td>${forecast.main.temp}</td>
                    <td>${forecast.main.humidity}</td>
                    <td>${forecast.weather[0].description}</td>
                    <td>${(forecast.pop * 100).toFixed(0)}</td>
                    <td>${forecast.wind.speed.toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function createGraphs(historical, forecast) {
            const times = historical.map(h => h.time).concat(forecast.map(f => f.dt_txt));
            const temps = historical.map(h => h.temp_c).concat(forecast.map(f => f.main.temp));
            const humidities = historical.map(h => h.humidity).concat(forecast.map(f => f.main.humidity));
            const winds = historical.map(h => h.wind_kph / 3.6).concat(forecast.map(f => f.wind.speed));

            new Chart(document.getElementById("temp-chart"), {
                type: "line",
                data: {
                    labels: times,
                    datasets: [{
                        label: "Temperature (°C)",
                        data: temps,
                        borderColor: "#4CAF50",
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "Temperature (°C)" } }
                    }
                }
            });

            new Chart(document.getElementById("humidity-chart"), {
                type: "line",
                data: {
                    labels: times,
                    datasets: [{
                        label: "Humidity (%)",
                        data: humidities,
                        borderColor: "#2196F3",
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "Humidity (%)" } }
                    }
                }
            });

            new Chart(document.getElementById("wind-chart"), {
                type: "line",
                data: {
                    labels: times,
                    datasets: [{
                        label: "Wind Speed (m/s)",
                        data: winds,
                        borderColor: "#FF9800",
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "Wind Speed (m/s)" } }
                    }
                }
            });
        }

        async function init() {
            const today = new Date();
            const todayStr = today.toISOString().split("T")[0];
            const historicalDates = [];

            // Automatically calculate the previous 2 days (e.g., June 29–30, 2025)
            for (let i = 2; i > 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                historicalDates.push(date.toISOString().split("T")[0]);
            }

            // Update date range in HTML
            const startDate = historicalDates[0];
            const endDate = "2025-07-03"; // Forecast up to July 3
            document.getElementById("date-range").innerText = `Historical (${startDate} to ${historicalDates[1]}), Current (${todayStr}), and Forecast (${todayStr} to ${endDate})`;
            document.getElementsByTagName("h2")[0].innerText = `Current Weather (${todayStr})`;
            document.getElementsByTagName("h2")[1].innerText = `Historical Weather (${startDate} to ${historicalDates[1]})`;
            document.getElementsByTagName("h2")[2].innerText = `Forecast (${todayStr} to ${endDate})`;

            // Fetch historical data (4 time points per day)
            const historical = [];
            for (const date of historicalDates) {
                const data = await getHistoricalData(date);
                historical.push(...data);
            }

            // Fetch current and forecast data
            const current = await getCurrentWeather();
            const forecast = await getForecastData();

            // Display data
            displayCurrentWeather(current);
            displayHistoricalData(historical);
            displayForecastData(forecast);

            // Create graphs
            createGraphs(historical, forecast);
        }

        init();
    </script>
</body>
</html>
