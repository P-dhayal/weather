<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anupgarh Weather Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        h1, h2, h3 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        canvas {
            max-width: 100%;
        }
        .current-weather {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .current-item {
            text-align: center;
            padding: 10px;
        }
        .current-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        @media (max-width: 600px) {
            table, th, td {
                font-size: 14px;
            }
            .current-weather {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Anupgarh Weather Dashboard</h1>
        <h3 id="date-range">Historical, Current, and Forecast Weather</h3>

        <h2 id="current-title">Current Weather</h2>
        <div class="current-weather" id="current-weather-container">
            <!-- Current weather will be inserted here by JavaScript -->
        </div>

        <h2 id="historical-title">Historical Weather</h2>
        <table id="historical-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Temperature (°C)</th>
                    <th>Humidity (%)</th>
                    <th>Weather</th>
                    <th>Rain Chance (%)</th>
                    <th>Wind Speed (m/s)</th>
                </tr>
            </thead>
            <tbody id="historical-body"></tbody>
        </table>

        <h2 id="forecast-title">Forecast</h2>
        <table id="forecast-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Temperature (°C)</th>
                    <th>Humidity (%)</th>
                    <th>Weather</th>
                    <th>Rain Chance (%)</th>
                    <th>Wind Speed (m/s)</th>
                </tr>
            </thead>
            <tbody id="forecast-body"></tbody>
        </table>

        <h2>Weather Graphs</h2>
        <div class="chart-container">
            <h3>Temperature (°C)</h3>
            <canvas id="temp-chart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Humidity (%)</h3>
            <canvas id="humidity-chart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Wind Speed (m/s)</h3>
            <canvas id="wind-chart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuration
        const config = {
            weatherapiKey: "28dc457030ec4e69bfe131408250107",
            owmApiKey: "ac1a9ad688dee52dfd615f7f65f230cf",
            lat: 29.1911,
            lon: 73.2086,
            daysToShow: {
                past: 2,
                future: 2
            }
        };

        // Date utilities
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(date) {
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function getDateRange() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const pastDates = [];
            for (let i = config.daysToShow.past; i > 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                pastDates.push(date);
            }
            
            const futureDates = [];
            for (let i = 1; i <= config.daysToShow.future; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                futureDates.push(date);
            }
            
            return {
                current: today,
                past: pastDates,
                future: futureDates
            };
        }

        // API functions
        async function getHistoricalData(date) {
            const dateStr = formatDate(date);
            const url = `https://api.weatherapi.com/v1/history.json?key=${config.weatherapiKey}&q=${config.lat},${config.lon}&dt=${dateStr}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.error) {
                    // Get 4 time points per day (00:00, 06:00, 12:00, 18:00)
                    const hours = data.forecast.forecastday[0].hour;
                    return hours.filter((_, index) => index % 6 === 0);
                } else {
                    console.error(`Historical error for ${dateStr}: ${data.error.message}`);
                    return generateMockHistoricalData(date);
                }
            } catch (e) {
                console.error(`Historical fetch error for ${dateStr}: ${e}`);
                return generateMockHistoricalData(date);
            }
        }

        function generateMockHistoricalData(date) {
            const dateStr = formatDate(date);
            return [
                { 
                    time: `${dateStr} 00:00`, 
                    temp_c: Math.round(25 + Math.random() * 5), 
                    humidity: Math.round(70 + Math.random() * 20), 
                    condition: { text: ["Sunny", "Partly Cloudy", "Cloudy"][Math.floor(Math.random() * 3)] }, 
                    chance_of_rain: Math.round(Math.random() * 30), 
                    wind_kph: (5 + Math.random() * 10).toFixed(1) 
                },
                { 
                    time: `${dateStr} 06:00`, 
                    temp_c: Math.round(24 + Math.random() * 4), 
                    humidity: Math.round(75 + Math.random() * 15), 
                    condition: { text: ["Sunny", "Partly Cloudy", "Cloudy"][Math.floor(Math.random() * 3)] }, 
                    chance_of_rain: Math.round(Math.random() * 20), 
                    wind_kph: (4 + Math.random() * 8).toFixed(1) 
                },
                { 
                    time: `${dateStr} 12:00`, 
                    temp_c: Math.round(28 + Math.random() * 7), 
                    humidity: Math.round(60 + Math.random() * 20), 
                    condition: { text: ["Sunny", "Partly Cloudy", "Cloudy"][Math.floor(Math.random() * 3)] }, 
                    chance_of_rain: Math.round(Math.random() * 10), 
                    wind_kph: (6 + Math.random() * 12).toFixed(1) 
                },
                { 
                    time: `${dateStr} 18:00`, 
                    temp_c: Math.round(26 + Math.random() * 6), 
                    humidity: Math.round(65 + Math.random() * 20), 
                    condition: { text: ["Sunny", "Partly Cloudy", "Cloudy"][Math.floor(Math.random() * 3)] }, 
                    chance_of_rain: Math.round(Math.random() * 15), 
                    wind_kph: (5 + Math.random() * 10).toFixed(1) 
                }
            ];
        }

        async function getCurrentWeather() {
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${config.lat}&lon=${config.lon}&appid=${config.owmApiKey}&units=metric`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.cod === 200) {
                    return {
                        time: new Date(data.dt * 1000),
                        temp: data.main.temp,
                        humidity: data.main.humidity,
                        weather: data.weather[0].description,
                        rain: data.rain ? data.rain["1h"] || 0 : 0,
                        wind: data.wind.speed,
                        icon: data.weather[0].icon
                    };
                } else {
                    console.error(`Current weather error: ${data.message}`);
                    return generateMockCurrentWeather();
                }
            } catch (e) {
                console.error(`Current weather fetch error: ${e}`);
                return generateMockCurrentWeather();
            }
        }

        function generateMockCurrentWeather() {
            const now = new Date();
            return {
                time: now,
                temp: Math.round(25 + Math.random() * 10),
                humidity: Math.round(60 + Math.random() * 30),
                weather: ["Sunny", "Partly Cloudy", "Cloudy", "Rainy"][Math.floor(Math.random() * 4)],
                rain: Math.round(Math.random() * 5),
                wind: (3 + Math.random() * 8).toFixed(1),
                icon: "01d"
            };
        }

        async function getForecastData() {
            const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${config.lat}&lon=${config.lon}&appid=${config.owmApiKey}&units=metric`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.cod === "200") {
                    // Get 4 time points per day (00:00, 06:00, 12:00, 18:00)
                    const forecast = [];
                    const targetTimes = ["00:00:00", "06:00:00", "12:00:00", "18:00:00"];
                    
                    data.list.forEach(item => {
                        const time = item.dt_txt.split(' ')[1];
                        if (targetTimes.includes(time)) {
                            forecast.push({
                                time: new Date(item.dt * 1000),
                                temp: item.main.temp,
                                humidity: item.main.humidity,
                                weather: item.weather[0].description,
                                rain: (item.pop * 100).toFixed(0),
                                wind: item.wind.speed,
                                icon: item.weather[0].icon
                            });
                        }
                    });
                    
                    return forecast;
                } else {
                    console.error(`Forecast error: ${data.message}`);
                    return generateMockForecastData();
                }
            } catch (e) {
                console.error(`Forecast fetch error: ${e}`);
                return generateMockForecastData();
            }
        }

        function generateMockForecastData() {
            const forecast = [];
            const now = new Date();
            
            for (let day = 1; day <= config.daysToShow.future; day++) {
                const date = new Date(now);
                date.setDate(now.getDate() + day);
                
                for (const time of ["00:00", "06:00", "12:00", "18:00"]) {
                    forecast.push({
                        time: new Date(`${formatDate(date)} ${time}`),
                        temp: Math.round(25 + Math.random() * 10 - day * 2),
                        humidity: Math.round(60 + Math.random() * 30 - day * 5),
                        weather: ["Sunny", "Partly Cloudy", "Cloudy", "Rainy"][Math.floor(Math.random() * 4)],
                        rain: Math.round(Math.random() * (10 + day * 5)),
                        wind: (3 + Math.random() * 8 + day).toFixed(1),
                        icon: `0${Math.floor(Math.random() * 5)}d`
                    });
                }
            }
            
            return forecast;
        }

        // Display functions
        function displayCurrentWeather(data) {
            const container = document.getElementById('current-weather-container');
            container.innerHTML = `
                <div class="current-item">
                    <div>Time</div>
                    <div class="current-value">${formatTime(data.time)}</div>
                </div>
                <div class="current-item">
                    <div>Temperature</div>
                    <div class="current-value">${Math.round(data.temp)}°C</div>
                </div>
                <div class="current-item">
                    <div>Humidity</div>
                    <div class="current-value">${data.humidity}%</div>
                </div>
                <div class="current-item">
                    <div>Weather</div>
                    <div class="current-value">${data.weather}</div>
                </div>
                <div class="current-item">
                    <div>Rain Chance</div>
                    <div class="current-value">${data.rain}%</div>
                </div>
                <div class="current-item">
                    <div>Wind Speed</div>
                    <div class="current-value">${data.wind} m/s</div>
                </div>
            `;
        }

        function displayHistoricalData(data) {
            const tbody = document.getElementById("historical-body");
            tbody.innerHTML = '';
            
            data.forEach(hour => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${hour.time.split(' ')[1]}</td>
                    <td>${hour.temp_c}</td>
                    <td>${hour.humidity}</td>
                    <td>${hour.condition.text}</td>
                    <td>${hour.chance_of_rain || 0}</td>
                    <td>${(hour.wind_kph / 3.6).toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayForecastData(data) {
            const tbody = document.getElementById("forecast-body");
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${formatTime(item.time)}</td>
                    <td>${Math.round(item.temp)}</td>
                    <td>${item.humidity}</td>
                    <td>${item.weather}</td>
                    <td>${item.rain}</td>
                    <td>${item.wind}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function createGraphs(historical, current, forecast) {
            // Prepare data for charts
            const labels = [];
            const temps = [];
            const humidities = [];
            const winds = [];
            
            // Add historical data
            historical.forEach(hour => {
                labels.push(hour.time.split(' ')[1]);
                temps.push(hour.temp_c);
                humidities.push(hour.humidity);
                winds.push(hour.wind_kph / 3.6);
            });
            
            // Add current weather (middle point)
            const currentHour = current.time.getHours();
            labels.push(`${currentHour}:00 (Now)`);
            temps.push(current.temp);
            humidities.push(current.humidity);
            winds.push(current.wind);
            
            // Add forecast data
            forecast.forEach(item => {
                labels.push(formatTime(item.time));
                temps.push(item.temp);
                humidities.push(item.humidity);
                winds.push(item.wind);
            });
            
            // Create temperature chart
            new Chart(document.getElementById("temp-chart"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Temperature (°C)",
                        data: temps,
                        borderColor: "#4CAF50",
                        backgroundColor: "rgba(76, 175, 80, 0.1)",
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { 
                            title: { display: true, text: "Time" },
                            grid: { display: false }
                        },
                        y: { 
                            title: { display: true, text: "Temperature (°C)" },
                            min: Math.min(...temps) - 5,
                            max: Math.max(...temps) + 5
                        }
                    }
                }
            });
            
            // Create humidity chart
            new Chart(document.getElementById("humidity-chart"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Humidity (%)",
                        data: humidities,
                        borderColor: "#2196F3",
                        backgroundColor: "rgba(33, 150, 243, 0.1)",
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { 
                            title: { display: true, text: "Time" },
                            grid: { display: false }
                        },
                        y: { 
                            title: { display: true, text: "Humidity (%)" },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            
            // Create wind chart
            new Chart(document.getElementById("wind-chart"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Wind Speed (m/s)",
                        data: winds,
                        borderColor: "#FF9800",
                        backgroundColor: "rgba(255, 152, 0, 0.1)",
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { 
                            title: { display: true, text: "Time" },
                            grid: { display: false }
                        },
                        y: { 
                            title: { display: true, text: "Wind Speed (m/s)" },
                            min: 0
                        }
                    }
                }
            });
        }

        // Update titles with date ranges
        function updateTitles(dateRange) {
            const currentDateStr = formatDate(dateRange.current);
            const pastStartStr = formatDate(dateRange.past[0]);
            const pastEndStr = formatDate(dateRange.past[dateRange.past.length - 1]);
            const futureEndStr = formatDate(dateRange.future[dateRange.future.length - 1]);
            
            document.getElementById("date-range").innerText = 
                `Historical (${pastStartStr} to ${pastEndStr}), Current (${currentDateStr}), and Forecast (${currentDateStr} to ${futureEndStr})`;
            
            document.getElementById("current-title").innerText = 
                `Current Weather - ${currentDateStr}`;
            
            document.getElementById("historical-title").innerText = 
                `Historical Weather - ${pastStartStr} to ${pastEndStr}`;
            
            document.getElementById("forecast-title").innerText = 
                `Forecast - ${currentDateStr} to ${futureEndStr}`;
        }

        // Main initialization function
        async function init() {
            // Get date range (automatically calculated)
            const dateRange = getDateRange();
            updateTitles(dateRange);
            
            // Fetch all data
            const historicalPromises = dateRange.past.map(date => getHistoricalData(date));
            const historicalData = (await Promise.all(historicalPromises)).flat();
            
            const currentWeather = await getCurrentWeather();
            const forecastData = await getForecastData();
            
            // Display data
            displayCurrentWeather(currentWeather);
            displayHistoricalData(historicalData);
            displayForecastData(forecastData);
            
            // Create graphs
            createGraphs(historicalData, currentWeather, forecastData);
        }

        // Initialize the dashboard
        init();
    </script>
</body>
</html>
