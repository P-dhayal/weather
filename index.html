<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anupgarh Weather Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
        .dashboard-header { background-color: #2c3e50; color: white; padding: 20px 0; }
        .weather-card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .table-responsive { overflow-x: auto; }
        .chart-container { position: relative; height: 300px; margin-bottom: 30px; }
        .weather-icon { font-size: 1.5em; vertical-align: middle; }
        .current-weather-icon { font-size: 3em; margin-bottom: 10px; }
        .time-column { white-space: nowrap; }
        .hourly-weather { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
        .hourly-card { 
            flex: 1 1 200px; 
            background: white; 
            border-radius: 8px; 
            padding: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .hourly-time { font-weight: bold; margin-bottom: 5px; }
        .hourly-temp { font-size: 1.2em; font-weight: bold; }
    </style>
</head>
<body>
    <div class="dashboard-header text-center">
        <h1>Anupgarh Weather Dashboard</h1>
        <p class="mb-0" id="date-range">Loading date range...</p>
    </div>

    <div class="container py-4">
        <!-- Current Weather Section -->
        <div class="weather-card card mb-4">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">Hourly Weather - July 2, 2025</h2>
            </div>
            <div class="card-body">
                <div class="hourly-weather" id="current-hourly">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Weather Charts -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="weather-card card">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0">Temperature (°C)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="weather-card card">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0">Humidity (%)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="humidityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="weather-card card">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0">Wind Speed (m/s)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="windChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Past Weather Table -->
        <div class="weather-card card mb-4">
            <div class="card-header bg-secondary text-white">
                <h2 class="mb-0" id="past-header">Past Weather</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th class="time-column">Time</th>
                                <th>Weather</th>
                                <th>Temp (°C)</th>
                                <th>Humidity (%)</th>
                                <th>Rain (%)</th>
                                <th>Wind (m/s)</th>
                            </tr>
                        </thead>
                        <tbody id="past-data">
                            <tr><td colspan="6" class="text-center">Loading past weather data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Forecast Section -->
        <div class="weather-card card mb-4">
            <div class="card-header bg-success text-white">
                <h2 class="mb-0" id="forecast-header">Forecast - Next 2 Days</h2>
            </div>
            <div class="card-body">
                <div id="forecast-days">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3">
        <p class="mb-0">Anupgarh Weather Dashboard - https://p-dhayal.github.io/weather/</p>
    </footer>

    <script>
        // Weather icon mapping
        function getWeatherIcon(weather) {
            if (!weather) return '🌤️';
            weather = weather.toLowerCase();
            if (weather.includes('rain')) return '🌧️';
            if (weather.includes('drizzle')) return '🌦️';
            if (weather.includes('cloud')) return '☁️';
            if (weather.includes('sun') || weather.includes('clear')) return '☀️';
            if (weather.includes('thunder')) return '⚡';
            if (weather.includes('fog') || weather.includes('mist')) return '🌫️';
            if (weather.includes('snow')) return '❄️';
            return '🌤️';
        }

        // Parse date from different formats in the JSON
        function parseDate(entry) {
            if (entry.time_epoch) {
                return new Date(entry.time_epoch * 1000);
            } else if (entry.time) {
                return new Date(entry.time);
            } else if (entry.dt_txt) {
                return new Date(entry.dt_txt);
            }
            return new Date();
        }

        // Format time display
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Format date display
        function formatDate(date) {
            return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Format date for table headers
        function formatTableDate(date) {
            return date.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Process and display weather data
        async function loadWeatherData() {
            try {
                const response = await fetch('weather_data.json');
                const weatherData = await response.json();
                
                // Find current date (July 2, 2025)
                const currentDate = new Date('2025-07-02T00:00:00');
                const currentDateStr = currentDate.toISOString().split('T')[0];
                
                // Get current day data (8 times per day)
                const currentDayData = weatherData.current_data || [];
                
                // Get forecast data (next days)
                const forecastData = weatherData.forecast_data || [];
                
                // Get past data (2 days before)
                const pastData = weatherData.past_data || [];

                // Update UI headers
                document.getElementById('date-range').textContent = 
                    `Past (June 30 to July 1, 2025), Current (July 2, 2025), Forecast (July 3-4, 2025)`;

                // Display current day hourly weather (8 times)
                displayHourlyWeather('current-hourly', currentDayData);

                // Prepare data for charts
                const allData = [...pastData, ...currentDayData, ...forecastData];
                const chartLabels = [];
                const tempData = [];
                const humidityData = [];
                const windData = [];

                allData.forEach(entry => {
                    const date = parseDate(entry);
                    chartLabels.push(formatTableDate(date));
                    tempData.push(entry.temp_c || entry.main?.temp || '--');
                    humidityData.push(entry.humidity || entry.main?.humidity || '--');
                    
                    // Convert wind speed to m/s if needed
                    let windSpeed = entry.wind_speed;
                    if (entry.wind_kph) {
                        windSpeed = entry.wind_kph / 3.6;
                    } else if (entry.wind?.speed) {
                        windSpeed = entry.wind.speed;
                    }
                    windData.push(windSpeed || '--');
                });

                // Create charts
                createCharts(chartLabels, tempData, humidityData, windData);

                // Display past weather table (4 times per day)
                displayWeatherTable('past-data', pastData);

                // Display forecast (next 2 days, 8 times per day)
                displayForecast(forecastData);

            } catch (error) {
                console.error('Error loading weather data:', error);
                document.getElementById('current-hourly').innerHTML = '<p>Error loading weather data</p>';
            }
        }

        function displayHourlyWeather(containerId, hourlyData) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!hourlyData || hourlyData.length === 0) {
                container.innerHTML = '<p>No hourly data available</p>';
                return;
            }

            hourlyData.forEach(entry => {
                const date = parseDate(entry);
                const time = formatTime(date);
                
                // Get weather description
                let weatherDesc = entry.condition?.text;
                if (!weatherDesc && entry.weather && entry.weather[0]) {
                    weatherDesc = entry.weather[0].description;
                }
                
                // Get temperature
                const temp = entry.temp_c || entry.main?.temp || '--';
                
                // Get rain chance
                let rainChance = entry.chance_of_rain;
                if (typeof entry.pop !== 'undefined') {
                    rainChance = Math.round(entry.pop * 100);
                }
                
                // Get wind speed
                let windSpeed = entry.wind_speed;
                if (entry.wind_kph) {
                    windSpeed = (entry.wind_kph / 3.6).toFixed(1);
                } else if (entry.wind?.speed) {
                    windSpeed = entry.wind.speed.toFixed(1);
                }

                container.innerHTML += `
                    <div class="hourly-card">
                        <div class="hourly-time">${time}</div>
                        <div class="weather-icon">${getWeatherIcon(weatherDesc)}</div>
                        <div class="hourly-temp">${temp}°C</div>
                        <div>${weatherDesc || '--'}</div>
                        <small>Rain: ${rainChance || '--'}%</small><br>
                        <small>Wind: ${windSpeed || '--'} m/s</small>
                    </div>
                `;
            });
        }

        function displayWeatherTable(tableId, tableData) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';

            if (!tableData || tableData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
                return;
            }

            tableData.forEach(entry => {
                const date = parseDate(entry);
                const hour = date.getHours();
                
                // Only show 6AM, 12PM, 6PM, 12AM for past data
                if ([0, 6, 12, 18].includes(hour)) {
                    // Get weather description
                    let weatherDesc = entry.condition?.text;
                    if (!weatherDesc && entry.weather && entry.weather[0]) {
                        weatherDesc = entry.weather[0].description;
                    }
                    
                    // Get temperature
                    const temp = entry.temp_c || entry.main?.temp || '--';
                    
                    // Get humidity
                    const humidity = entry.humidity || entry.main?.humidity || '--';
                    
                    // Get rain chance
                    let rainChance = entry.chance_of_rain;
                    if (typeof entry.pop !== 'undefined') {
                        rainChance = Math.round(entry.pop * 100);
                    }
                    
                    // Get wind speed
                    let windSpeed = entry.wind_speed;
                    if (entry.wind_kph) {
                        windSpeed = (entry.wind_kph / 3.6).toFixed(1);
                    } else if (entry.wind?.speed) {
                        windSpeed = entry.wind.speed.toFixed(1);
                    }

                    tableBody.innerHTML += `
                        <tr>
                            <td>${formatTableDate(date)}</td>
                            <td><span class="weather-icon">${getWeatherIcon(weatherDesc)}</span> ${weatherDesc || '--'}</td>
                            <td>${temp}</td>
                            <td>${humidity}</td>
                            <td>${rainChance || '--'}</td>
                            <td>${windSpeed || '--'}</td>
                        </tr>
                    `;
                }
            });

            if (tableBody.innerHTML === '') {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No matching time points found</td></tr>';
            }
        }

        function displayForecast(forecastData) {
    const container = document.getElementById('forecast-days');
    container.innerHTML = '';

    if (!forecastData || forecastData.length === 0) {
        container.innerHTML = '<p>No forecast data available</p>';
        return;
    }

    // Current date is July 2, 2025
    const currentDate = new Date('2025-07-02T00:00:00');
    const nextDay1 = new Date(currentDate);
    nextDay1.setDate(currentDate.getDate() + 1); // July 3
    const nextDay2 = new Date(currentDate);
    nextDay2.setDate(currentDate.getDate() + 2); // July 4

    const day1Str = nextDay1.toISOString().split('T')[0];
    const day2Str = nextDay2.toISOString().split('T')[0];

    // Filter forecast data for only July 3 and 4
    const day1Entries = forecastData.filter(entry => {
        const date = parseDate(entry);
        return date.toISOString().split('T')[0] === day1Str;
    });

    const day2Entries = forecastData.filter(entry => {
        const date = parseDate(entry);
        return date.toISOString().split('T')[0] === day2Str;
    });

    // Display July 3
    if (day1Entries.length > 0) {
        const dayName = nextDay1.toLocaleDateString([], { weekday: 'long' });
        container.innerHTML += `
            <div class="mb-4">
                <h4>${dayName}, 3rd July</h4>
                <div class="hourly-weather">
                    ${day1Entries.map(entry => {
                        const time = formatTime(parseDate(entry));
                        const weatherDesc = entry.weather?.[0]?.description || '--';
                        const temp = entry.main?.temp || '--';
                        const rainChance = Math.round((entry.pop || 0) * 100);
                        const windSpeed = entry.wind?.speed?.toFixed(1) || '--';
                        
                        return `
                            <div class="hourly-card">
                                <div class="hourly-time">${time}</div>
                                <div class="weather-icon">${getWeatherIcon(weatherDesc)}</div>
                                <div class="hourly-temp">${temp}°C</div>
                                <div>${weatherDesc}</div>
                                <small>Rain: ${rainChance}%</small><br>
                                <small>Wind: ${windSpeed} m/s</small>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // Display July 4
    if (day2Entries.length > 0) {
        const dayName = nextDay2.toLocaleDateString([], { weekday: 'long' });
        container.innerHTML += `
            <div class="mb-4">
                <h4>${dayName}, 4th July</h4>
                <div class="hourly-weather">
                    ${day2Entries.map(entry => {
                        const time = formatTime(parseDate(entry));
                        const weatherDesc = entry.weather?.[0]?.description || '--';
                        const temp = entry.main?.temp || '--';
                        const rainChance = Math.round((entry.pop || 0) * 100);
                        const windSpeed = entry.wind?.speed?.toFixed(1) || '--';
                        
                        return `
                            <div class="hourly-card">
                                <div class="hourly-time">${time}</div>
                                <div class="weather-icon">${getWeatherIcon(weatherDesc)}</div>
                                <div class="hourly-temp">${temp}°C</div>
                                <div>${weatherDesc}</div>
                                <small>Rain: ${rainChance}%</small><br>
                                <small>Wind: ${windSpeed} m/s</small>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
}

        function createCharts(labels, tempData, humidityData, windData) {
            // Temperature Chart
            new Chart(
                document.getElementById('tempChart').getContext('2d'),
                {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Temperature (°C)',
                            data: tempData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: getChartOptions('°C')
                }
            );

            // Humidity Chart
            new Chart(
                document.getElementById('humidityChart').getContext('2d'),
                {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Humidity (%)',
                            data: humidityData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: getChartOptions('%', 0, 100)
                }
            );

            // Wind Chart
            new Chart(
                document.getElementById('windChart').getContext('2d'),
                {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Wind Speed (m/s)',
                            data: windData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: getChartOptions('m/s')
                }
            );
        }

        function getChartOptions(unit, min, max) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        min: min,
                        max: max,
                        title: {
                            display: true,
                            text: unit
                        }
                    }
                }
            };
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadWeatherData);
    </script>
</body>
</html>
