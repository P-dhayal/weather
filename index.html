<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anupgarh Weather Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
        .dashboard-header { background-color: #2c3e50; color: white; padding: 20px 0; }
        .weather-card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .table-responsive { overflow-x: auto; }
        .chart-container { position: relative; height: 300px; margin-bottom: 30px; }
        .weather-icon { font-size: 1.5em; vertical-align: middle; }
        .current-weather-icon { font-size: 3em; margin-bottom: 10px; }
        .time-column { white-space: nowrap; }
    </style>
</head>
<body>
    <div class="dashboard-header text-center">
        <h1>Anupgarh Weather Dashboard</h1>
        <p class="mb-0" id="date-range">Loading date range...</p>
    </div>

    <div class="container py-4">
        <!-- Current Weather Section -->
        <div class="weather-card card mb-4">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0" id="current-date-header">Current Weather</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 text-center">
                        <div class="current-weather-icon" id="current-icon">‚è≥</div>
                        <h3 id="current-temp">--¬∞C</h3>
                        <h4 id="current-weather">Loading...</h4>
                        <p id="current-time">--:-- --</p>
                    </div>
                    <div class="col-md-6">
                        <div class="current-details pt-3">
                            <p><strong>Humidity:</strong> <span id="current-humidity">--%</span></p>
                            <p><strong>Rain Chance:</strong> <span id="current-rain">--%</span></p>
                            <p><strong>Wind Speed:</strong> <span id="current-wind">-- m/s</span></p>
                            <p><strong>Feels Like:</strong> <span id="current-feelslike">--¬∞C</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weather Charts -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="weather-card card">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0">Temperature (¬∞C)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="weather-card card">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0">Humidity (%)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="humidityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="weather-card card">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0">Wind Speed (m/s)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="windChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Past Weather Table -->
        <div class="weather-card card mb-4">
            <div class="card-header bg-secondary text-white">
                <h2 class="mb-0" id="past-header">Past Weather</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th class="time-column">Time</th>
                                <th>Weather</th>
                                <th>Temp (¬∞C)</th>
                                <th>Humidity (%)</th>
                                <th>Rain (%)</th>
                                <th>Wind (m/s)</th>
                            </tr>
                        </thead>
                        <tbody id="past-data">
                            <tr><td colspan="6" class="text-center">Loading past weather data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Forecast Table -->
        <div class="weather-card card mb-4">
            <div class="card-header bg-success text-white">
                <h2 class="mb-0" id="forecast-header">Forecast</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th class="time-column">Time</th>
                                <th>Weather</th>
                                <th>Temp (¬∞C)</th>
                                <th>Humidity (%)</th>
                                <th>Rain (%)</th>
                                <th>Wind (m/s)</th>
                            </tr>
                        </thead>
                        <tbody id="forecast-data">
                            <tr><td colspan="6" class="text-center">Loading forecast data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3">
        <p class="mb-0">Anupgarh Weather Dashboard - https://p-dhayal.github.io/weather/</p>
    </footer>

    <script>
        // Weather icon mapping
        function getWeatherIcon(weather) {
            if (!weather) return 'üå§Ô∏è';
            weather = weather.toLowerCase();
            if (weather.includes('rain')) return 'üåßÔ∏è';
            if (weather.includes('drizzle')) return 'üå¶Ô∏è';
            if (weather.includes('cloud')) return '‚òÅÔ∏è';
            if (weather.includes('sun') || weather.includes('clear')) return '‚òÄÔ∏è';
            if (weather.includes('thunder')) return '‚ö°';
            if (weather.includes('fog') || weather.includes('mist')) return 'üå´Ô∏è';
            if (weather.includes('snow')) return '‚ùÑÔ∏è';
            return 'üå§Ô∏è';
        }

        // Parse date from different formats in the JSON
        function parseDate(entry) {
            if (entry.time_epoch) {
                return new Date(entry.time_epoch * 1000);
            } else if (entry.time) {
                return new Date(entry.time);
            }
            return new Date();
        }

        // Format time display
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Format date display
        function formatDate(date) {
            return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Format date for table headers
        function formatTableDate(date) {
            return date.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Process and display weather data
        async function loadWeatherData() {
            try {
                const response = await fetch('weather_data.json');
                const weatherData = await response.json();
                
                if (!weatherData || !Array.isArray(weatherData)) {
                    throw new Error('Invalid weather data format');
                }

                // Parse all dates and sort the data
                const processedData = weatherData.map(entry => ({
                    ...entry,
                    date: parseDate(entry)
                })).sort((a, b) => a.date - b.date);

                // Find current date (July 2, 2025)
                const currentDate = new Date('2025-07-02T00:00:00');
                const currentDateStr = currentDate.toISOString().split('T')[0];
                
                // Group data by date
                const groupedData = {};
                processedData.forEach(entry => {
                    const dateStr = entry.date.toISOString().split('T')[0];
                    if (!groupedData[dateStr]) {
                        groupedData[dateStr] = [];
                    }
                    groupedData[dateStr].push(entry);
                });

                // Sort dates
                const sortedDates = Object.keys(groupedData).sort();
                const currentIndex = sortedDates.indexOf(currentDateStr);
                
                if (currentIndex === -1) {
                    throw new Error('Current date (July 2, 2025) not found in data');
                }

                // Get past dates (2 days before current)
                const pastDates = sortedDates.slice(Math.max(0, currentIndex - 2), currentIndex);
                
                // Get forecast dates (2 days after current)
                const forecastDates = sortedDates.slice(currentIndex + 1, currentIndex + 3);

                // Find current weather entry (noon on current date)
                const currentEntries = groupedData[currentDateStr] || [];
                const currentEntry = currentEntries.find(entry => 
                    entry.date.getHours() === 12
                ) || currentEntries[currentEntries.length - 1] || {};

                // Update UI headers
                document.getElementById('date-range').textContent = 
                    `Past (${pastDates.length ? formatDate(new Date(pastDates[0])) : '--'} to ${formatDate(new Date(currentDateStr))}), ` +
                    `Current (${formatDate(new Date(currentDateStr))}), ` +
                    `Forecast (${forecastDates.length ? formatDate(new Date(forecastDates[0])) : '--'} to ${forecastDates.length > 1 ? formatDate(new Date(forecastDates[1])) : '--'})`;

                document.getElementById('current-date-header').textContent = 
                    `Current Weather (${formatDate(new Date(currentDateStr))})`;
                document.getElementById('past-header').textContent = 
                    `Past Weather (${pastDates.length ? formatDate(new Date(pastDates[0])) : '--'} to ${formatDate(new Date(currentDateStr))})`;
                document.getElementById('forecast-header').textContent = 
                    `Forecast (${forecastDates.length ? formatDate(new Date(forecastDates[0])) : '--'} to ${forecastDates.length > 1 ? formatDate(new Date(forecastDates[1])) : '--'})`;

                // Display current weather
                displayCurrentWeather(currentEntry);

                // Prepare data for charts
                const chartLabels = [];
                const tempData = [];
                const humidityData = [];
                const windData = [];

                processedData.forEach(entry => {
                    chartLabels.push(formatTableDate(entry.date));
                    tempData.push(entry.temp_c);
                    humidityData.push(entry.humidity);
                    windData.push(entry.wind_kph ? entry.wind_kph / 3.6 : entry.wind_speed);
                });

                // Create charts
                createCharts(chartLabels, tempData, humidityData, windData);

                // Display past weather table
                displayWeatherTable('past-data', pastDates, groupedData);

                // Display forecast table
                displayWeatherTable('forecast-data', forecastDates, groupedData);

            } catch (error) {
                console.error('Error loading weather data:', error);
                document.getElementById('current-weather').textContent = 'Error loading data';
            }
        }

        function displayCurrentWeather(entry) {
            document.getElementById('current-icon').textContent = getWeatherIcon(entry.condition?.text || entry.weather);
            document.getElementById('current-temp').textContent = `${entry.temp_c || '--'}¬∞C`;
            document.getElementById('current-weather').textContent = entry.condition?.text || entry.weather || '--';
            document.getElementById('current-time').textContent = entry.date ? formatTime(entry.date) : '--:-- --';
            document.getElementById('current-humidity').textContent = `${entry.humidity || '--'}%`;
            document.getElementById('current-rain').textContent = `${entry.chance_of_rain || entry.rain_chance || '--'}%`;
            document.getElementById('current-wind').textContent = `${entry.wind_kph ? (entry.wind_kph / 3.6).toFixed(1) : entry.wind_speed?.toFixed(1) || '--'} m/s`;
            document.getElementById('current-feelslike').textContent = `${entry.feelslike_c || entry.temp_c || '--'}¬∞C`;
        }

        function displayWeatherTable(tableId, dates, groupedData) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';

            if (!dates.length) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
                return;
            }

            dates.forEach(date => {
                groupedData[date]?.forEach(entry => {
                    const hour = entry.date.getHours();
                    
                    // Only show 6AM, 12PM, 6PM, 12AM
                    if ([0, 6, 12, 18].includes(hour)) {
                        tableBody.innerHTML += `
                            <tr>
                                <td>${formatTableDate(entry.date)}</td>
                                <td><span class="weather-icon">${getWeatherIcon(entry.condition?.text || entry.weather)}</span> ${entry.condition?.text || entry.weather || '--'}</td>
                                <td>${entry.temp_c || '--'}</td>
                                <td>${entry.humidity || '--'}</td>
                                <td>${entry.chance_of_rain || entry.rain_chance || '--'}</td>
                                <td>${entry.wind_kph ? (entry.wind_kph / 3.6).toFixed(1) : entry.wind_speed?.toFixed(1) || '--'}</td>
                            </tr>
                        `;
                    }
                });
            });

            if (tableBody.innerHTML === '') {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No matching time points found</td></tr>';
            }
        }

        function createCharts(labels, tempData, humidityData, windData) {
            // Temperature Chart
            new Chart(
                document.getElementById('tempChart').getContext('2d'),
                {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Temperature (¬∞C)',
                            data: tempData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: getChartOptions('¬∞C')
                }
            );

            // Humidity Chart
            new Chart(
                document.getElementById('humidityChart').getContext('2d'),
                {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Humidity (%)',
                            data: humidityData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: getChartOptions('%', 0, 100)
                }
            );

            // Wind Chart
            new Chart(
                document.getElementById('windChart').getContext('2d'),
                {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Wind Speed (m/s)',
                            data: windData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: getChartOptions('m/s')
                }
            );
        }

        function getChartOptions(unit, min, max) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        min: min,
                        max: max,
                        title: {
                            display: true,
                            text: unit
                        }
                    }
                }
            };
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadWeatherData);
    </script>
</body>
</html>
